name: Build and Deploy JupyterLite

on:
  push:
    branches:
    - main
  workflow_dispatch:


permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip wheel
        python -m pip install jupyterlite-core
        python -m pip install -r jupyter-lite/requirements.txt

    - name: Copy data to content directory
      run: |
        # Create directory structure
        mkdir -p jupyter-lite/content/data/fresh_service_tickets

        # Copy CSV files
        cp -r data/fresh_service_tickets/*.csv jupyter-lite/content/data/fresh_service_tickets/

        # List files to verify
        echo "Files copied to jupyter-lite/content/data/fresh_service_tickets:"
        ls -la jupyter-lite/content/data/fresh_service_tickets/

    - name: Build JupyterLite
      run: |
        # Install the package without changing directory
        python -m pip install -e jupyter-lite

        # Make sure static directory exists
        mkdir -p jupyter-lite/static

        # Change directory and build with config
        cd jupyter-lite

        jupyter lite build --config pyproject.toml

        # Create data directories in the output directory
        mkdir -p _output/files/data/fresh_service_tickets
        cp -r ../../data/fresh_service_tickets/*.csv _output/files/data/fresh_service_tickets/

        # List files to verify
        echo "Files copied to output directory:"
        ls -la _output/files/data/fresh_service_tickets/

        # Copy output to dist directory
        mkdir -p ../dist
        cp -r _output/* ../dist/

    - name: Fix output directory permissions
      run: |
        chmod -R 755 dist

    - name: Deploy to GitHub Pages
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: dist
        branch: gh-pages
